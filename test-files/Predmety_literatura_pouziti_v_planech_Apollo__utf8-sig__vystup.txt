
PØEFORMÁTOVANÝ DOTAZ (bez komentáøù):
-------------------------------------
WITH pr_tmp AS
  (SELECT pr.zkratka AS pr,
          ap.nazev AS predmet ,
          pr.predmet_id ,
          ap.rok,
          org.org_acronym AS fak ,
          ap.ustav_id ,
          row_number() OVER (PARTITION BY pr.predmet_id
                             ORDER BY ap.nazev,
                                      ap.aktualni_predmet_id ASC) AS rn
   FROM
     (SELECT *
      FROM st01.predmet
      WHERE predmet.status = 9
        AND predmet.fakulta_id = :fakulta_id ) pr
   INNER JOIN st01.aktualni_predmet ap ON (ap.predmet_id = pr.predmet_id
                                           AND ap.status = 9
                                           AND ap.rok = :akrok )
   LEFT JOIN brutisadm.orgunit org ON org.orgunitid = pr.fakulta_id ) ,
     pp_tmp AS
  (SELECT ap05.predmet_id ,
          listagg(DISTINCT ap05.aktualni_predmet_id, ', ') within group(
                                                                        ORDER BY ap05.predmet_id) AS ID_aktualnich_predmetu ,
                                                                  listagg(DISTINCT cts.zkratka, ', ') within group(
                                                                                                                   ORDER BY cts.zkratka) AS typy ,
                                                                                                             listagg(DISTINCT org.org_acronym, ', ') within group(
                                                                                                                                                                  ORDER BY org.org_acronym) AS fakulty_programu ,
                                                                                                                                                            listagg(DISTINCT cfs.zkratka, ', ') within group(
                                                                                                                                                                                                             ORDER BY cfs.zkratka) AS formy ,
                                                                                                                                                                                                       listagg(DISTINCT pg.zkratka, ', ') within group(
                                                                                                                                                                                                                                                       ORDER BY pg.zkratka) AS programy ,
                                                                                                                                                                                                                                                 listagg(DISTINCT pg.nazev, '; ') within group(
                                                                                                                                                                                                                                                                                               ORDER BY pg.nazev) AS programy_nazvy ,
                                                                                                                                                                                                                                                                                         listagg(DISTINCT ro.cislo_rocniku, ', ') within group(
                                                                                                                                                                                                                                                                                                                                               ORDER BY ro.cislo_rocniku) AS rocniky ,
                                                                                                                                                                                                                                                                                                                                         listagg(DISTINCT pg.zkratka || ' (' || cts.zkratka || cfs.zkratka || ' ' || ro.cislo_rocniku || '.r) - ' || pg.nazev, '; ') within group(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ORDER BY ro.cislo_rocniku) AS popis
   FROM pr_tmp pr05
   INNER JOIN st01.aktualni_predmet ap05 ON (ap05.predmet_id = pr05.predmet_id
                                             AND pr05.rn = 1
                                             AND ap05.rok = pr05.rok
                                             AND ap05.status = 9)
   INNER JOIN st01.predmet_planu pp05 ON (pp05.aktualni_predmet_id = ap05.aktualni_predmet_id
                                          AND pp05.status = 9)
   INNER JOIN st01.semestr se ON (se.semestr_id = pp05.semestr_id
                                  AND se.status = 9)
   INNER JOIN st01.rocnik ro ON (ro.rocnik_id = se.rocnik_id
                                 AND ro.status = 9)
   INNER JOIN st01.stupen st ON (st.stupen_id = ro.stupen_id
                                 AND st.status = 9)
   INNER JOIN st01.obor ob ON (ob.obor_id = ro.obor_id
                               AND ob.status = 9)
   INNER JOIN st01.program pg ON (pg.program_id = ob.program_id
                                  AND pg.status = 9)
   INNER JOIN st01.c_typ_studia cts ON (cts.typ_studia_id = pg.typ_studia_id
                                        AND cts.status = 9)
   INNER JOIN st01.c_forma_studia cfs ON (cfs.forma_studia_id = pg.forma_studia_id
                                          AND cfs.status = 9)
   INNER JOIN brutisadm.orgunit org ON org.orgunitid = pg.fakulta_id
   GROUP BY ap05.predmet_id) ,
     prl_tmp AS
  (SELECT prl.fak,
          prl.rok,
          orgu.org_acronym AS ust,
          ot.orgunit_name AS ustav ,
          ppt.ID_aktualnich_predmetu ,
          prl.predmet_id ,
          prl.pr,
          prl.predmet ,
          li.literatura_id ,
          ctl.popis AS typ_literatury,
          li.poradove_cislo,
          li.jazyk ,
          REPLACE(li.citace, chr(10), ' ') AS citace ,
          li.pub_id ,
          ppt.fakulty_programu,
          ppt.typy,
          ppt.formy,
          ppt.programy,
          ppt.programy_nazvy ,
          ppt.rocniky,
          ppt.popis
   FROM pr_tmp prl
   INNER JOIN st01.literatura li ON (li.predmet_id = prl.predmet_id
                                     AND prl.rn = 1
                                     AND prl.rok BETWEEN li.rok_od AND nvl(li.rok_do, prl.rok)
                                     AND li.status = 9)
   INNER JOIN st01.c_typ_literatury ctl ON ctl.typ_literatury_id = li.typ_literatury_id
   LEFT JOIN pp_tmp ppt ON ppt.predmet_id = prl.predmet_id
   LEFT JOIN brutisadm.orgunit orgu ON orgu.orgunitid = prl.ustav_id
   LEFT JOIN brutisadm.orgunit_translation ot ON (ot.orgunitid = orgu.orgunitid
                                                  AND ot.orgunit_trans_type = 'o'
                                                  AND ot.status = 9
                                                  AND ot.actual = 1))
SELECT tmp.*
FROM prl_tmp tmp
ORDER BY fak,
         rok,
         ust,
         pr,
         typ_literatury DESC,
         poradove_cislo,
         jazyk
-------------------------------------

TABULKA pr_tmp (ID 0)
    Aliasy:
        pr05
        prl
    Attributy:
        ap.nazev (alias: predmet)
        ap.rok
        ap.ustav_id (alias: ---- Kazdy predmet se vezme jen 1x (filtr rn = 1)
            )
        org.org_acronym (alias: fak)
        pr.predmet_id
        pr.zkratka (alias: pr)
    Vazba na tabulky:
        select-0 (ID 1)
        join-0 (ID 4)
        join-1 (ID 6)
    Komentáø:
        "-- as pr_tmp     --------------------------- [...]"
    SQL kód:
        "pr_tmp as (select pr.zkratka as pr, ap.nazev [...]"

TABULKA select-0 (ID 1)
    Aliasy:
        pr
    Attributy:
        *
        predmet.fakulta_id = :fakulta_id
        predmet.status = 9
    Vazba na tabulky:
        st01.predmet (ID 2)
    Komentáø:
        ""
    SQL kód:
        "select * from st01.predmet where predmet.sta [...]"

TABULKA st01.predmet (ID 2)
    Aliasy:
        <žádné>
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA st01.aktualni_predmet (ID 3)
    Aliasy:
        ap
        ap05
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-0 (ID 4)
    Aliasy:
        <žádné>
    Attributy:
        ap.predmet_id = pr.predmet_id
        ap.rok = :akrok
        ap.status = 9
    Vazba na tabulky:
        st01.aktualni_predmet (ID 3)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.aktualni_predmet ap          [...]"

TABULKA brutisadm.orgunit (ID 5)
    Aliasy:
        org
        orgu
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-1 (ID 6)
    Aliasy:
        <žádné>
    Attributy:
        org.orgunitid = pr.fakulta_id
    Vazba na tabulky:
        brutisadm.orgunit (ID 5)
    Komentáø:
        ""
    SQL kód:
        "left join brutisadm.orgunit org              [...]"

TABULKA pp_tmp (ID 7)
    Aliasy:
        ppt
    Attributy:
        ap05.predmet_id (alias: --            , pg.program_id, ob.obor_id
--            , st.stupen_id, ro.rocnik_id, se.semestr_id
            )
        listagg(distinct ap05.aktualni_predmet_id,', ') (alias: within)
    Vazba na tabulky:
        pr_tmp (ID 0)
        join-2 (ID 8)
        join-3 (ID 10)
        join-4 (ID 12)
        join-5 (ID 14)
        join-6 (ID 16)
        join-7 (ID 18)
        join-8 (ID 20)
        join-9 (ID 22)
        join-10 (ID 24)
        join-11 (ID 25)
    Komentáø:
        "-- as pp_tmp     --------------------------- [...]"
    SQL kód:
        "pp_tmp as (select ap05.predmet_id --         [...]"

TABULKA join-2 (ID 8)
    Aliasy:
        <žádné>
    Attributy:
        ap05.predmet_id = pr05.predmet_id
        ap05.rok = pr05.rok
        ap05.status = 9
        pr05.rn = 1
    Vazba na tabulky:
        st01.aktualni_predmet (ID 3)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.aktualni_predmet ap05        [...]"

TABULKA st01.predmet_planu (ID 9)
    Aliasy:
        pp05
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-3 (ID 10)
    Aliasy:
        <žádné>
    Attributy:
        pp05.aktualni_predmet_id = ap05.aktualni_predmet_id
        pp05.status = 9
    Vazba na tabulky:
        st01.predmet_planu (ID 9)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.predmet_planu pp05           [...]"

TABULKA st01.semestr (ID 11)
    Aliasy:
        se
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-4 (ID 12)
    Aliasy:
        <žádné>
    Attributy:
        se.semestr_id = pp05.semestr_id
        se.status = 9
    Vazba na tabulky:
        st01.semestr (ID 11)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.semestr se                   [...]"

TABULKA st01.rocnik (ID 13)
    Aliasy:
        ro
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-5 (ID 14)
    Aliasy:
        <žádné>
    Attributy:
        ro.rocnik_id = se.rocnik_id
        ro.status = 9
    Vazba na tabulky:
        st01.rocnik (ID 13)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.rocnik ro                    [...]"

TABULKA st01.stupen (ID 15)
    Aliasy:
        st
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-6 (ID 16)
    Aliasy:
        <žádné>
    Attributy:
        st.status = 9
        st.stupen_id = ro.stupen_id
    Vazba na tabulky:
        st01.stupen (ID 15)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.stupen st                    [...]"

TABULKA st01.obor (ID 17)
    Aliasy:
        ob
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-7 (ID 18)
    Aliasy:
        <žádné>
    Attributy:
        ob.obor_id = ro.obor_id
        ob.status = 9
    Vazba na tabulky:
        st01.obor (ID 17)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.obor ob                      [...]"

TABULKA st01.program (ID 19)
    Aliasy:
        pg
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-8 (ID 20)
    Aliasy:
        <žádné>
    Attributy:
        pg.program_id = ob.program_id
        pg.status = 9
    Vazba na tabulky:
        st01.program (ID 19)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.program pg                   [...]"

TABULKA st01.c_typ_studia (ID 21)
    Aliasy:
        cts
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-9 (ID 22)
    Aliasy:
        <žádné>
    Attributy:
        cts.status = 9
        cts.typ_studia_id = pg.typ_studia_id
    Vazba na tabulky:
        st01.c_typ_studia (ID 21)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.c_typ_studia cts             [...]"

TABULKA st01.c_forma_studia (ID 23)
    Aliasy:
        cfs
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-10 (ID 24)
    Aliasy:
        <žádné>
    Attributy:
        cfs.forma_studia_id = pg.forma_studia_id
        cfs.status = 9
    Vazba na tabulky:
        st01.c_forma_studia (ID 23)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.c_forma_studia cfs           [...]"

TABULKA join-11 (ID 25)
    Aliasy:
        <žádné>
    Attributy:
        org.orgunitid = pg.fakulta_id
    Vazba na tabulky:
        brutisadm.orgunit (ID 5)
    Komentáø:
        ""
    SQL kód:
        "inner join brutisadm.orgunit org             [...]"

TABULKA prl_tmp (ID 26)
    Aliasy:
        tmp
    Attributy:
        REPLACE(li.citace, chr(10), ' ') (alias: citace)
        ctl.popis (alias: typ_literatury)
        li.jazyk
        li.literatura_id
        li.poradove_cislo
        li.pub_id
        orgu.org_acronym (alias: ust)
        ot.orgunit_name (alias: ustav)
        ppt.ID_aktualnich_predmetu
        ppt.fakulty_programu
        ppt.formy
        ppt.popis (alias: --            , row_number() over ( partition by li.literatura_id
--                                  order by prl.pr asc) as rn
        )
        ppt.programy
        ppt.programy_nazvy
        ppt.rocniky
        ppt.typy
        prl.fak
        prl.pr
        prl.predmet
        prl.predmet_id
        prl.rok
    Vazba na tabulky:
        pr_tmp (ID 0)
        join-12 (ID 28)
        join-13 (ID 30)
        join-14 (ID 31)
        join-15 (ID 32)
        join-16 (ID 34)
    Komentáø:
        "-- as prl_tmp     -------------------------- [...]"
    SQL kód:
        "prl_tmp as (select             prl.fak, prl. [...]"

TABULKA st01.literatura (ID 27)
    Aliasy:
        li
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-12 (ID 28)
    Aliasy:
        <žádné>
    Attributy:
        li.predmet_id = prl.predmet_id
        li.rok_od AND 
        li.status = 9
        prl.rn = 1
        prl.rok BETWEEN 
    Vazba na tabulky:
        st01.literatura (ID 27)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.literatura li                [...]"

TABULKA st01.c_typ_literatury (ID 29)
    Aliasy:
        ctl
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-13 (ID 30)
    Aliasy:
        <žádné>
    Attributy:
        ctl.typ_literatury_id = li.typ_literatury_id
    Vazba na tabulky:
        st01.c_typ_literatury (ID 29)
    Komentáø:
        ""
    SQL kód:
        "inner join st01.c_typ_literatury ctl         [...]"

TABULKA join-14 (ID 31)
    Aliasy:
        <žádné>
    Attributy:
        ppt.predmet_id = prl.predmet_id
    Vazba na tabulky:
        pp_tmp (ID 7)
    Komentáø:
        ""
    SQL kód:
        "left join pp_tmp ppt                         [...]"

TABULKA join-15 (ID 32)
    Aliasy:
        <žádné>
    Attributy:
        orgu.orgunitid = prl.ustav_id
    Vazba na tabulky:
        brutisadm.orgunit (ID 5)
    Komentáø:
        ""
    SQL kód:
        "left join brutisadm.orgunit orgu             [...]"

TABULKA brutisadm.orgunit_translation (ID 33)
    Aliasy:
        ot
    Attributy:
        <žádné>
    Vazba na tabulky:
        <žádné>
    Komentáø:
        ""
    SQL kód:
        ""

TABULKA join-16 (ID 34)
    Aliasy:
        <žádné>
    Attributy:
        ot.actual = 1
        ot.orgunit_trans_type = 'o'
        ot.orgunitid = orgu.orgunitid
        ot.status = 9
    Vazba na tabulky:
        brutisadm.orgunit_translation (ID 33)
    Komentáø:
        ""
    SQL kód:
        "left join brutisadm.orgunit_translation ot o [...]"

TABULKA select-1 (ID 35)
    Aliasy:
        <žádné>
    Attributy:
        tmp.*
    Vazba na tabulky:
        prl_tmp (ID 26)
    Komentáø:
        ""
    SQL kód:
        "select tmp.* from prl_tmp tmp --where -- tmp [...]"

